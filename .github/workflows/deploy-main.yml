name: ë©”ì¸ ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ í”„ë¡œë•ì…˜ ë°°í¬

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Java 21 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        run: ./gradlew clean build -x test

      - name: ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: ì˜¨í”„ë ˆë¯¸ìŠ¤ ì„œë²„ ë°°í¬
    runs-on: self-hosted
    needs: build
    environment:
      name: production
    env:
      # GitHub Secretsë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ë§¤í•‘
      MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      JWT_EXPIRY: ${{ secrets.JWT_EXPIRY }}
      KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
      KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
      # [ì¤‘ìš”] í„°ë„ í† í° ì¶”ê°€
      CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: docker-compose.prod.yml ìƒì„±
        shell: bash
        run: |
          # [ì¤‘ìš”] EOFì— ë”°ì˜´í‘œë¥¼ ì œê±°í•˜ì—¬ ë³€ìˆ˜ê°€ ì‹¤ì œ ê°’ìœ¼ë¡œ ë°”ë€Œë„ë¡ í•¨
          cat <<EOF > docker-compose.prod.yml
          services:
            # 1. Cloudflare Tunnel (ë³´ì•ˆ í„°ë„)
            tunnel:
              image: cloudflare/cloudflared:latest
              container_name: cloudflare-tunnel
              restart: unless-stopped
              command: tunnel run
              environment:
                - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
              depends_on:
                - nginx
              networks:
                - hamalog-network

            # 2. Nginx (í¬íŠ¸ ë‹«ê¸° - ë³´ì•ˆ)
            nginx:
              image: nginx:alpine
              container_name: nginx-hamalog
              expose:
                - "80"
              volumes:
                - ./nginx-docker.conf:/etc/nginx/conf.d/default.conf:ro
              depends_on:
                - hamalog-app
              networks:
                - hamalog-network
              restart: unless-stopped

            hamalog-app:
              image: ${REGISTRY}/${IMAGE_NAME}:latest
              container_name: hamalog-app
              expose:
                - "8080"
              environment:
                - SPRING_PROFILES_ACTIVE=prod
                - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-hamalog:3306/${DB_NAME}
                - SPRING_DATASOURCE_USERNAME=${DB_USERNAME}
                - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
                - SPRING_DATA_REDIS_HOST=redis
                - SPRING_DATA_REDIS_PORT=6379
                - JWT_SECRET=${JWT_SECRET}
                - JWT_EXPIRY=${JWT_EXPIRY}
                - KAKAO_CLIENT_ID=${KAKAO_CLIENT_ID}
                - KAKAO_CLIENT_SECRET=${KAKAO_CLIENT_SECRET}
              depends_on:
                mysql-hamalog:
                  condition: service_healthy
                redis:
                  condition: service_healthy
              networks:
                - hamalog-network
              restart: unless-stopped

            redis:
              image: redis:7-alpine
              container_name: hamalog-redis
              expose:
                - "6379"
              command: redis-server --appendonly yes
              volumes:
                - redis-data:/data
              networks:
                - hamalog-network
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "redis-cli", "ping"]
                interval: 30s
                timeout: 10s
                retries: 3

            mysql-hamalog:
              image: mysql:8.0
              container_name: mysql-hamalog
              expose:
                - "3306"
              environment:
                - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
                - MYSQL_DATABASE=${DB_NAME}
                - MYSQL_USER=${DB_USERNAME}
                - MYSQL_PASSWORD=${DB_PASSWORD}
              volumes:
                - mysql-data:/var/lib/mysql
              networks:
                - hamalog-network
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
                interval: 30s
                timeout: 10s
                retries: 3

          networks:
            hamalog-network:
              driver: bridge

          volumes:
            mysql-data:
            redis-data:
          EOF

      - name: ë„¤íŠ¸ì›Œí¬ ìƒì„± í™•ì¸
        shell: bash
        run: |
          docker network inspect hamalog-network >/dev/null 2>&1 || docker network create hamalog-network

      - name: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
        shell: bash
        run: |
          docker compose -p hamalog -f docker-compose.prod.yml down --remove-orphans || true

      - name: ìµœì‹  ì´ë¯¸ì§€ Pull
        shell: bash
        run: |
          docker pull ${REGISTRY}/${IMAGE_NAME}:latest

      - name: ì„œë¹„ìŠ¤ ì‹œì‘
        shell: bash
        run: |
          docker compose -p hamalog -f docker-compose.prod.yml up -d

      - name: ë°°í¬ í™•ì¸
        shell: bash
        run: |
          echo "ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸"
          docker compose -p hamalog -f docker-compose.prod.yml ps
          
          attempts=20
          for i in $(seq 1 $attempts); do
            # Nginx ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ í—¬ìŠ¤ì²´í¬
            if docker exec nginx-hamalog wget -q --spider http://localhost/actuator/health 2>/dev/null; then
              echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
              docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
              exit 0
            fi
            echo "ì¬ì‹œë„ ${i}/${attempts}..."
            sleep 10
          done
          
          echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          docker compose -p hamalog -f docker-compose.prod.yml logs --tail=100
          exit 1

      - name: ì •ë¦¬ ì‘ì—…
        if: always()
        shell: bash
        run: |
          rm -f docker-compose.prod.yml
          docker image prune -f || true

      - name: ë°°í¬ ì•Œë¦¼
        if: always()
        shell: bash
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ğŸŒ ì• í”Œë¦¬ì¼€ì´ì…˜ URL: https://api.hamalog.shop"
            echo "ğŸ”’ Cloudflare Tunnelì„ í†µí•´ ì•ˆì „í•˜ê²Œ ì„œë¹„ìŠ¤ë©ë‹ˆë‹¤."
          else
            echo "âŒ ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"
          fi

