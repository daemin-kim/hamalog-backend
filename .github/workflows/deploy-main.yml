name: ë©”ì¸ ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ í”„ë¡œë•ì…˜ ë°°í¬

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Java 21 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Gradle íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
        run: ./gradlew clean build

      - name: ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Hamalog ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
    permissions:
      contents: read
      packages: read
    env:
      SPRING_PROFILES_ACTIVE: prod
      MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      JWT_EXPIRY: ${{ secrets.JWT_EXPIRY }}
      KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
      KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: í•„ìˆ˜ ì‹œí¬ë¦¿ ê²€ì¦
        run: |
          set -euo pipefail
          missing=0
          for var in MYSQL_ROOT_PASSWORD DB_NAME DB_USERNAME DB_PASSWORD JWT_SECRET JWT_EXPIRY KAKAO_CLIENT_ID KAKAO_CLIENT_SECRET; do
            if [ -z "${!var:-}" ]; then
              echo "::error::í•„ìˆ˜ ì‹œí¬ë¦¿ ${var} ê°’ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then
            exit 1
          fi

      - name: docker-compose.prod.yml ìƒì„±
        run: |
          cat <<'EOF' > docker-compose.prod.yml
          services:
            hamalog-app:
              image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
              ports:
                - "8080:8080"
              environment:
                - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
                - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-hamalog:3306/${DB_NAME}
                - SPRING_DATASOURCE_USERNAME=${DB_USERNAME}
                - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
                - SPRING_DATA_REDIS_HOST=redis
                - SPRING_DATA_REDIS_PORT=6379
                - JWT_SECRET=${JWT_SECRET}
                - JWT_EXPIRY=${JWT_EXPIRY}
                - KAKAO_CLIENT_ID=${KAKAO_CLIENT_ID}
                - KAKAO_CLIENT_SECRET=${KAKAO_CLIENT_SECRET}
              depends_on:
                mysql-hamalog:
                  condition: service_healthy
                redis:
                  condition: service_healthy
              restart: unless-stopped

            redis:
              image: redis:7-alpine
              ports:
                - "6379:6379"
              command: redis-server --appendonly yes
              volumes:
                - redis-data:/data
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "redis-cli", "ping"]
                interval: 30s
                timeout: 10s
                retries: 3

            mysql-hamalog:
              image: mysql:8.0
              ports:
                - "3306:3306"
              environment:
                - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
                - MYSQL_DATABASE=${DB_NAME}
                - MYSQL_USER=${DB_USERNAME}
                - MYSQL_PASSWORD=${DB_PASSWORD}
              volumes:
                - mysql-data:/var/lib/mysql
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
                interval: 30s
                timeout: 10s
                retries: 3

          volumes:
            mysql-data:
            redis-data:
          EOF

      - name: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
        run: docker compose -p hamalog -f docker-compose.prod.yml down --remove-orphans || true

      - name: ìµœì‹  ì´ë¯¸ì§€ Pull
        run: docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: ì„œë¹„ìŠ¤ ì‹œì‘
        run: docker compose -p hamalog -f docker-compose.prod.yml up -d

      - name: ë°°í¬ í™•ì¸
        run: |
          echo "ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸"
          docker compose -p hamalog -f docker-compose.prod.yml ps
          attempts=10
          for i in $(seq 1 $attempts); do
            if curl -f -s -m 10 http://localhost:8080/actuator/health >/dev/null 2>&1; then
              echo "ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
              exit 0
            fi
            echo "ì¬ì‹œë„ ${i}/${attempts}"
            sleep 10
          done
          echo "ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          docker compose -p hamalog -f docker-compose.prod.yml logs hamalog-app --tail=50
          exit 1

      - name: ì •ë¦¬ ì‘ì—…
        if: always()
        run: |
          rm -f docker-compose.prod.yml
          docker image prune -f || true

      - name: ë°°í¬ ì•Œë¦¼
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ğŸŒ ì• í”Œë¦¬ì¼€ì´ì…˜ URL: http://localhost:8080"
          else
            echo "âŒ ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"
          fi