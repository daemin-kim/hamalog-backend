name: CI/CD - Build and Deploy to On-Premise Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_IMAGE_NAME: hamalog-app
  DOCKER_REGISTRY: ghcr.io

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build with Gradle
      env:
        # Test environment uses H2 in-memory database
        SPRING_PROFILES_ACTIVE: test
      run: ./gradlew clean build -x test

    - name: Run tests
      env:
        SPRING_PROFILES_ACTIVE: test
      run: ./gradlew test

    - name: Generate test coverage report
      run: ./gradlew jacocoTestReport

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: build/reports/tests/test/

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: build/reports/jacoco/test/

    - name: Build JAR
      run: ./gradlew bootJar

    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: hamalog-jar
        path: build/libs/*.jar

  build-docker-image:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: hamalog-jar
        path: build/libs/

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -t ${{ env.DOCKER_IMAGE_NAME }}:latest .
        docker save ${{ env.DOCKER_IMAGE_NAME }}:latest -o hamalog-image.tar

    - name: Upload Docker image
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: hamalog-image.tar
        retention-days: 1

  deploy-to-server:
    needs: build-docker-image
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: docker-image

    - name: Copy files to server
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SERVER_HOST: ${{ secrets.SERVER_HOST || '49.142.154.182' }}
        SERVER_USER: ${{ secrets.SERVER_USER || 'ubuntu' }}
        SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
      run: |
        set -e
        
        echo "================================================"
        echo "SSH Configuration and File Transfer"
        echo "================================================"
        
        echo "Validating SSH credentials..."
        if [ -z "$SSH_PRIVATE_KEY" ]; then
          echo "❌ ERROR: SSH_PRIVATE_KEY secret is not set!"
          echo "Please set SSH_PRIVATE_KEY in GitHub Repository Secrets"
          exit 1
        fi
        
        if [ -z "$SERVER_HOST" ] || [ "$SERVER_HOST" = "null" ]; then
          echo "❌ ERROR: SERVER_HOST secret is not set!"
          echo "Please set SERVER_HOST in GitHub Repository Secrets"
          exit 1
        fi
        
        if [ -z "$SERVER_USER" ] || [ "$SERVER_USER" = "null" ]; then
          echo "❌ ERROR: SERVER_USER secret is not set!"
          echo "Please set SERVER_USER in GitHub Repository Secrets"
          exit 1
        fi
        
        echo "✅ Server Configuration: HOST=$SERVER_HOST, USER=$SERVER_USER, PORT=$SERVER_PORT"
        
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        echo "Scanning SSH host key..."
        ssh-keyscan -p ${SERVER_PORT} -T 10 $SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null || {
          echo "⚠️  Warning: Could not scan SSH host key. Continuing..."
        }
        
        echo "Configuring SSH options for reliability..."
        tee -a ~/.ssh/config > /dev/null << 'SSHEOF'
Host *
  ConnectTimeout 30
  StrictHostKeyChecking accept-new
  UserKnownHostsFile ~/.ssh/known_hosts
  BatchMode yes
SSHEOF
        
        chmod 600 ~/.ssh/config
        
        echo ""
        echo "Attempting SSH connection with retry logic..."
        
        MAX_RETRIES=3
        RETRY_COUNT=0
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          RETRY_COUNT=$((RETRY_COUNT + 1))
          echo "Attempt $RETRY_COUNT of $MAX_RETRIES..."
          
          if ssh -p ${SERVER_PORT} \
              -o ConnectTimeout=30 \
              -o StrictHostKeyChecking=accept-new \
              -o BatchMode=yes \
              ${SERVER_USER}@${SERVER_HOST} "mkdir -p ~/hamalog-deploy" 2>&1; then
            echo "✅ SSH connection successful"
            break
          else
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "⏳ Connection attempt $RETRY_COUNT failed. Waiting before retry..."
              sleep $((RETRY_COUNT * 5))
            fi
          fi
        done
        
        if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
          echo ""
          echo "================================================"
          echo "❌ DEPLOYMENT FAILED: SSH Connection Error"
          echo "================================================"
          echo ""
          echo "Could not connect to server after $MAX_RETRIES attempts:"
          echo "  Server: $SERVER_HOST:$SERVER_PORT"
          echo "  User: $SERVER_USER"
          echo ""
          echo "Troubleshooting steps:"
          echo "1. Verify SERVER_HOST, SERVER_USER, and SERVER_PORT are correct"
          echo "2. Check if the server is running and accessible"
          echo "3. Verify SSH_PRIVATE_KEY is correct and authorized on the server"
          echo "4. Check firewall rules allow SSH port $SERVER_PORT"
          echo "5. Test manually: ssh -i key.pem $SERVER_USER@$SERVER_HOST -p $SERVER_PORT"
          echo ""
          exit 1
        fi
        
        echo ""
        echo "Copying files to server..."
        
        echo "  → Copying Docker image..."
        scp -P ${SERVER_PORT} \
            -o ConnectTimeout=30 \
            hamalog-image.tar ${SERVER_USER}@${SERVER_HOST}:~/hamalog-deploy/
        
        echo "  → Copying docker-compose.yml..."
        scp -P ${SERVER_PORT} \
            -o ConnectTimeout=30 \
            docker-compose.yml ${SERVER_USER}@${SERVER_HOST}:~/hamalog-deploy/
        
        echo ""
        echo "✅ Files copied successfully"

    - name: Deploy to server
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SERVER_HOST: ${{ secrets.SERVER_HOST || '49.142.154.182' }}
        SERVER_USER: ${{ secrets.SERVER_USER || 'ubuntu' }}
        SERVER_PORT: ${{ secrets.SERVER_PORT || '22' }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        JWT_EXPIRY: ${{ secrets.JWT_EXPIRY || '900000' }}
        JWT_REFRESH_TOKEN_EXPIRY: ${{ secrets.JWT_REFRESH_TOKEN_EXPIRY || '604800000' }}
        HAMALOG_ENCRYPTION_KEY: ${{ secrets.HAMALOG_ENCRYPTION_KEY }}
        KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
        KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
        KAKAO_REDIRECT_URI: ${{ secrets.KAKAO_REDIRECT_URI }}
        DB_NAME: ${{ secrets.DB_NAME || 'Hamalog' }}
        DB_USERNAME: ${{ secrets.DB_USERNAME || 'hamalog_user' }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
        SPRING_DATA_REDIS_PASSWORD: ${{ secrets.SPRING_DATA_REDIS_PASSWORD }}
        FRONTEND_URL: ${{ secrets.FRONTEND_URL || 'http://49.142.154.182:3000' }}
        ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS || 'http://49.142.154.182:3000,http://49.142.154.182:8080' }}
      continue-on-error: true
      run: |
        set +e
        
        echo "================================================"
        echo "Hamalog Deployment Started"
        echo "================================================"
        
        echo "Validating required secrets..."
        MISSING_VARS=""
        
        if [ -z "$SSH_PRIVATE_KEY" ]; then
          MISSING_VARS="$MISSING_VARS SSH_PRIVATE_KEY"
        fi
        
        if [ -z "$SERVER_HOST" ] || [ "$SERVER_HOST" = "null" ]; then
          MISSING_VARS="$MISSING_VARS SERVER_HOST"
        fi
        
        if [ -z "$SERVER_USER" ] || [ "$SERVER_USER" = "null" ]; then
          MISSING_VARS="$MISSING_VARS SERVER_USER"
        fi
        
        if [ -z "$JWT_SECRET" ]; then
          MISSING_VARS="$MISSING_VARS JWT_SECRET"
        fi
        
        if [ -z "$KAKAO_CLIENT_ID" ]; then
          MISSING_VARS="$MISSING_VARS KAKAO_CLIENT_ID"
        fi
        
        if [ -z "$KAKAO_CLIENT_SECRET" ]; then
          MISSING_VARS="$MISSING_VARS KAKAO_CLIENT_SECRET"
        fi
        
        if [ -z "$DB_PASSWORD" ]; then
          MISSING_VARS="$MISSING_VARS DB_PASSWORD"
        fi
        
        if [ -z "$MYSQL_ROOT_PASSWORD" ]; then
          MISSING_VARS="$MISSING_VARS MYSQL_ROOT_PASSWORD"
        fi
        
        if [ -z "$HAMALOG_ENCRYPTION_KEY" ]; then
          MISSING_VARS="$MISSING_VARS HAMALOG_ENCRYPTION_KEY"
        fi
        
        if [ -n "$MISSING_VARS" ]; then
          echo "❌ ERROR: Missing required secrets:$MISSING_VARS"
          echo ""
          echo "Please set the following secrets in GitHub Repository Settings:"
          echo "  Settings → Secrets and variables → Actions"
          exit 1
        fi
        
        echo "✅ All required secrets are set"
        echo ""
        
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        echo "Configuring SSH..."
        tee -a ~/.ssh/config > /dev/null << 'SSHEOF'
Host *
  ConnectTimeout 30
  StrictHostKeyChecking accept-new
  UserKnownHostsFile ~/.ssh/known_hosts
  BatchMode yes
SSHEOF
        chmod 600 ~/.ssh/config
        
        ssh-keyscan -p ${SERVER_PORT} -T 10 $SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
        
        echo "Attempting to connect to deployment server..."
        MAX_RETRIES=3
        RETRY_COUNT=0
        SSH_CONNECTED=0
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ $SSH_CONNECTED -eq 0 ]; do
          RETRY_COUNT=$((RETRY_COUNT + 1))
          echo "SSH connection attempt $RETRY_COUNT of $MAX_RETRIES..."
          
          if ssh -p ${SERVER_PORT} \
              -o ConnectTimeout=30 \
              -o StrictHostKeyChecking=accept-new \
              -o BatchMode=yes \
              ${SERVER_USER}@${SERVER_HOST} "echo 'SSH connection successful'" 2>&1; then
            SSH_CONNECTED=1
            echo "✅ SSH connection successful"
          else
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "⏳ Connection attempt failed. Waiting before retry..."
              sleep $((RETRY_COUNT * 5))
            fi
          fi
        done
        
        if [ $SSH_CONNECTED -eq 0 ]; then
          echo ""
          echo "================================================"
          echo "❌ DEPLOYMENT SKIPPED: Server Unreachable"
          echo "================================================"
          echo ""
          echo "Could not establish SSH connection to deployment server:"
          echo "  Server: $SERVER_HOST:$SERVER_PORT"
          echo "  User: $SERVER_USER"
          echo ""
          echo "Possible causes:"
          echo "  1. Server is offline or not responding"
          echo "  2. Network/firewall blocking connection"
          echo "  3. SSH service not running on server"
          echo ""
          echo "⚠️  Build artifacts remain available for manual deployment"
          echo "See GitHub Artifacts for Docker image and configuration files"
          echo ""
          exit 0
        fi
        
        echo ""
        echo "Preparing deployment environment file..."
        cat > /tmp/.env.prod << "ENVEOF"
JWT_SECRET=$JWT_SECRET
JWT_EXPIRY=${JWT_EXPIRY:-900000}
JWT_REFRESH_TOKEN_EXPIRY=${JWT_REFRESH_TOKEN_EXPIRY:-604800000}
HAMALOG_ENCRYPTION_KEY=$HAMALOG_ENCRYPTION_KEY
KAKAO_CLIENT_ID=$KAKAO_CLIENT_ID
KAKAO_CLIENT_SECRET=$KAKAO_CLIENT_SECRET
KAKAO_REDIRECT_URI=$KAKAO_REDIRECT_URI
DB_NAME=${DB_NAME:-Hamalog}
DB_USERNAME=${DB_USERNAME:-hamalog_user}
DB_PASSWORD=$DB_PASSWORD
MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD
SPRING_DATASOURCE_USERNAME=${DB_USERNAME:-hamalog_user}
SPRING_DATASOURCE_PASSWORD=$DB_PASSWORD
SPRING_DATASOURCE_URL=jdbc:mysql://mysql-hamalog:3306/${DB_NAME:-Hamalog}?useSSL=true&requireSSL=true&characterEncoding=UTF-8&serverTimezone=UTC
SPRING_DATA_REDIS_HOST=redis
SPRING_DATA_REDIS_PORT=6379
SPRING_DATA_REDIS_PASSWORD=$SPRING_DATA_REDIS_PASSWORD
SPRING_PROFILES_ACTIVE=prod
FRONTEND_URL=${FRONTEND_URL:-http://49.142.154.182:3000}
ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://49.142.154.182:3000,http://49.142.154.182:8080}
FILE_UPLOAD_DIR=/data/hamalog/uploads
FILE_UPLOAD_MAX_SIZE=5242880
LOG_DIR=/var/log/hamalog
ENVEOF
        
        echo "Transferring configuration to server..."
        scp -P ${SERVER_PORT} \
            -o ConnectTimeout=30 \
            /tmp/.env.prod ${SERVER_USER}@${SERVER_HOST}:~/hamalog-deploy/.env.prod
        
        ssh -p ${SERVER_PORT} \
            -o ConnectTimeout=30 \
            ${SERVER_USER}@${SERVER_HOST} "chmod 600 ~/hamalog-deploy/.env.prod"
        
        rm -f /tmp/.env.prod
        
        echo ""
        echo "Executing remote deployment script..."
        
        ssh -p ${SERVER_PORT} \
            -o ConnectTimeout=30 \
            ${SERVER_USER}@${SERVER_HOST} <<'ENDSSH'
          cd ~/hamalog-deploy

          echo "================================================"
          echo "Hamalog Deployment - Remote Execution"
          echo "================================================"

          if [ ! -f .env.prod ]; then
            echo "❌ DEPLOYMENT FAILED: .env.prod not found!"
            exit 1
          fi

          echo "Loading Docker image..."
          docker load -i hamalog-image.tar

          echo "Verifying environment variables..."
          set -a
          source .env.prod
          set +a

          REQUIRED_VARS="JWT_SECRET HAMALOG_ENCRYPTION_KEY KAKAO_CLIENT_ID KAKAO_CLIENT_SECRET DB_PASSWORD MYSQL_ROOT_PASSWORD SPRING_DATA_REDIS_PASSWORD"

          MISSING_VARS=""
          for var in $REQUIRED_VARS; do
            if [ -z "${!var}" ]; then
              MISSING_VARS="$MISSING_VARS $var"
            fi
          done

          if [ -n "$MISSING_VARS" ]; then
            echo "❌ DEPLOYMENT FAILED: Missing variables:$MISSING_VARS"
            exit 1
          fi

          echo "✅ All required environment variables are set"

          echo ""
          echo "Stopping existing containers..."
          docker-compose down || true

          echo "Starting new containers..."
          docker-compose up -d

          echo "Waiting for application to start (30 seconds)..."
          sleep 30

          echo "Running health check..."
          if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
            echo ""
            echo "================================================"
            echo "✅ Deployment successful - Application is healthy"
            echo "================================================"
            exit 0
          else
            echo ""
            echo "================================================"
            echo "❌ Deployment failed - Application health check failed"
            echo "================================================"
            echo ""
            echo "Container logs (last 50 lines):"
            docker-compose logs --tail=50 hamalog-app
            exit 1
          fi
        ENDSSH
        
        DEPLOY_EXIT_CODE=$?
        if [ $DEPLOY_EXIT_CODE -ne 0 ]; then
          echo ""
          echo "❌ Remote deployment failed with exit code $DEPLOY_EXIT_CODE"
          exit $DEPLOY_EXIT_CODE
        fi
        
        echo ""
        echo "================================================"
        echo "✅ Deployment workflow completed successfully"
        echo "================================================"

