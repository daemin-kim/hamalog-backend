# Hamalog 배포 오류 해결 보고서

## 발생한 문제

### 1. 주요 오류 메시지
```
hamalog-app Error manifest unknown
Error response from daemon: manifest unknown
❌ Deployment failed with exit code: 1
```

### 2. 문제 상황
- GitHub Actions를 통한 Docker 이미지 빌드는 성공
- 하지만 배포 단계에서 Docker 이미지를 찾을 수 없어 실패
- `ghcr.io/daemin-kim/hamalog-backend:668954c5c0232cdf94abdf6e8198cb99673548ca` 이미지를 pull할 수 없음

## 문제 원인 분석

### 1. 이미지명 불일치 문제
- **GitHub Actions에서 빌드되는 이미지**: `ghcr.io/daemin-kim/hamalog-backend:태그`
- **배포 스크립트에서 찾는 이미지**: `ghcr.io/hamalog:태그`
- deploy.sh에서 `IMAGE_NAME="${REGISTRY}/${GITHUB_REPOSITORY:-hamalog}"`로 설정되어 있었지만, GITHUB_REPOSITORY 환경변수가 전달되지 않아 기본값 "hamalog"가 사용됨

### 2. Docker Compose 버전 경고
- `docker-compose.yml`과 배포 스크립트에서 생성되는 `docker-compose.prod.yml`에서 `version: '3.8'` 속성 사용
- 최신 Docker Compose에서는 해당 속성이 deprecated되어 경고 메시지 발생

### 3. 환경변수 전달 누락
- GitHub Actions에서 deploy.sh로 GITHUB_REPOSITORY와 GITHUB_SHA 환경변수가 제대로 전달되지 않음

## 해결 방안

### 1. 이미지명 불일치 해결
**수정 전:**
```bash
IMAGE_NAME="${REGISTRY}/${GITHUB_REPOSITORY:-hamalog}"
```

**수정 후:**
```bash
IMAGE_NAME="${REGISTRY}/${GITHUB_REPOSITORY:-daemin-kim/hamalog-backend}"
```
- 기본값을 실제 리포지토리명으로 변경하여 환경변수가 없어도 올바른 이미지명 사용

### 2. GitHub Actions 환경변수 추가
GitHub Actions workflow에 다음 환경변수 추가:
```yaml
export GITHUB_REPOSITORY="${{ github.repository }}"
export GITHUB_SHA="${{ github.sha }}"
```

### 3. Docker Compose 버전 경고 해결
- `docker-compose.yml`에서 `version: '3.8'` 제거
- `deploy.sh`에서 생성하는 `docker-compose.prod.yml`에서도 version 속성 제거

## 수정 사항 요약

### 파일별 변경사항

1. **deploy.sh**
   - IMAGE_NAME 기본값을 'hamalog'에서 'daemin-kim/hamalog-backend'로 변경
   - 생성되는 docker-compose.prod.yml에서 version 속성 제거

2. **docker-compose.yml**
   - deprecated version 속성 제거

3. **.github/workflows/deploy-main.yml**
   - GITHUB_REPOSITORY와 GITHUB_SHA 환경변수 명시적 추가

## 기대 효과

### 1. 배포 성공
- 올바른 이미지명으로 Docker 이미지를 정상적으로 pull 가능
- "manifest unknown" 오류 해결

### 2. 경고 메시지 제거
- Docker Compose 실행 시 version 관련 경고 메시지 제거
- 더 깔끔한 배포 로그

### 3. 환경변수 일관성
- GitHub Actions와 배포 스크립트 간 환경변수 전달 개선
- 더 안정적인 배포 프로세스

## 검증 방법

다음 배포 시 확인해야 할 사항:
1. Docker 이미지 pull이 성공적으로 수행되는지 확인
2. version 관련 경고 메시지가 사라졌는지 확인
3. 애플리케이션이 정상적으로 시작되고 health check가 통과하는지 확인

## 결론

이번 오류는 주로 **이미지명 불일치**와 **환경변수 전달 누락**으로 인한 문제였습니다. GitHub Actions에서 빌드된 이미지와 배포 시 참조하는 이미지명이 달라서 "manifest unknown" 오류가 발생했으며, 이를 해결하기 위해 환경변수 전달을 개선하고 기본값을 올바르게 설정했습니다. 

추가적으로 Docker Compose의 deprecated 속성도 제거하여 더 깔끔한 배포 환경을 구축했습니다.