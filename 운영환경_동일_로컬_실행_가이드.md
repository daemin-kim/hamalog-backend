# 운영환경과 동일한 로컬 실행 환경 가이드

## 🎯 개요

이 가이드는 Hamalog 애플리케이션을 로컬에서 운영환경과 완전히 동일한 설정으로 실행하는 방법을 제공합니다. GitHub에 푸시되어 운영환경에 배포되기 전에 로컬에서 미리 문제를 확인할 수 있도록 도와줍니다.

## 🛠 사전 준비 사항

### 필수 소프트웨어
- **Docker Desktop**: 설치되어 있어야 하며 실행 중이어야 합니다
- **Git**: 프로젝트 클론용
- **터미널/명령 프롬프트**: 명령어 실행용

### 시스템 요구 사항
- **메모리**: 최소 4GB RAM (8GB 권장)
- **디스크**: 최소 2GB 여유 공간
- **포트**: 3306, 6379, 8080, 8200 포트가 사용 가능해야 함

## 🚀 단계별 실행 가이드

### 1단계: Docker Desktop 실행 확인

먼저 Docker Desktop이 정상적으로 실행되고 있는지 확인합니다:

```bash
# Docker 상태 확인
docker --version
docker info

# 정상 출력 예시가 나와야 함
```

**macOS에서 Docker Desktop 시작:**
```bash
open -a Docker
```

**Windows에서 Docker Desktop 시작:**
- 시작 메뉴에서 "Docker Desktop" 검색하여 실행

### 2단계: 프로젝트 디렉토리로 이동

```bash
cd /path/to/your/Hamalog/project
# 예: cd /Users/your-username/ideaProjects/Hamalog
```

### 3단계: 운영환경과 동일한 로컬 환경 시작

```bash
# 운영환경 동일 로컬 환경 시작
./run-production-local.sh start
```

이 명령어는 다음 서비스들을 자동으로 시작합니다:
- **MySQL 8.0** (포트 3306) - 운영용 데이터베이스
- **Redis 7 Alpine** (포트 6379) - 캐싱 및 세션 관리
- **HashiCorp Vault 1.15.2** (포트 8200) - 보안 키 관리
- **Hamalog Application** (포트 8080) - 메인 애플리케이션

### 4단계: 서비스 상태 확인

```bash
# 모든 서비스 상태 확인
./run-production-local.sh status

# 실시간 로그 확인
./run-production-local.sh logs

# 특정 서비스 로그만 확인 (예: 애플리케이션)
docker logs hamalog-hamalog-app-1 -f
```

### 5단계: 애플리케이션 접근 테스트

```bash
# 헬스 체크 (HTTP 302 응답이 정상)
curl -I http://localhost:8080

# 또는 브라우저에서 직접 접근
open http://localhost:8080
```

## 🔐 보안 키 관리 (Vault 설정)

### Vault 초기 설정

환경이 처음 시작될 때 Vault에 보안 키들이 자동으로 설정되지 않을 수 있습니다. 다음 명령어로 수동 설정합니다:

```bash
# Vault에 보안 키 설정
docker exec hamalog-vault-local sh -c "
VAULT_ADDR=http://localhost:8200 VAULT_TOKEN=hamalog-dev-token vault kv put secret/hamalog \
  jwt-secret='EzUuJwKK4vLnvk5r7yAgdNP/sa1dL87febZhlayPGjI=' \
  encryption-key='7u+EyAhNyWu2hebIO0XoqUH1gwdoyyHKxcIKC2+A6aM=' \
  kakao-client-id='86f21dfff5d2e9e3e1f76167df979268' \
  kakao-client-secret='ScyrNoUeoFLrCNS5MB7CF2kKxUVzaymx'
"
```

### Vault에서 키 확인

```bash
# 저장된 키 확인
curl -s http://localhost:8200/v1/secret/data/hamalog \
  -H "X-Vault-Token: hamalog-dev-token" | jq '.data.data'
```

## 📊 접근 정보

### 애플리케이션 URL
- **메인 애플리케이션**: http://localhost:8080
- **헬스 체크**: http://localhost:8080/actuator/health
- **Vault UI**: http://localhost:8200

### 데이터베이스 접근 정보
- **호스트**: localhost:3306
- **데이터베이스**: Hamalog
- **사용자명**: hamalog_user
- **비밀번호**: `.env.prod-local` 파일 참조

### Vault 접근 정보
- **Root Token**: hamalog-dev-token
- **키 확인**: `vault kv get secret/hamalog`

## 🛑 환경 종료

### 정상 종료
```bash
./run-production-local.sh stop
```

### 완전 정리 (모든 데이터 삭제)
```bash
./run-production-local.sh clean
```

## 🔧 문제 해결

### 일반적인 문제들

#### 1. 포트 충돌 문제
```bash
# 포트 사용 중인 프로세스 확인
lsof -i :8080   # 또는 :3306, :6379, :8200

# 해당 프로세스 종료
kill -9 <PID>
```

#### 2. Docker Desktop이 시작되지 않는 경우
```bash
# macOS
pkill -f Docker
open -a Docker

# 권한 문제 해결
sudo chown -R $(whoami) ~/.docker
```

#### 3. Vault 연결 문제
```bash
# Vault 컨테이너 상태 확인
docker logs hamalog-vault-local

# Vault 헬스 체크
curl -s http://localhost:8200/v1/sys/health
```

#### 4. 애플리케이션 시작 실패
```bash
# 애플리케이션 로그 확인
docker logs hamalog-hamalog-app-1 --tail 100

# 의존 서비스 상태 확인
docker-compose -f docker-compose.local.yml --env-file .env.prod-local ps
```

#### 5. 메모리 부족 문제
- Docker Desktop 설정에서 메모리 할당량을 최소 4GB로 설정
- 불필요한 다른 Docker 컨테이너들 종료

### 서비스별 개별 재시작

```bash
# MySQL만 재시작
docker-compose -f docker-compose.local.yml --env-file .env.prod-local restart mysql-hamalog

# Redis만 재시작
docker-compose -f docker-compose.local.yml --env-file .env.prod-local restart redis

# Vault만 재시작
docker-compose -f docker-compose.local.yml --env-file .env.prod-local restart vault

# 애플리케이션만 재시작
docker-compose -f docker-compose.local.yml --env-file .env.prod-local restart hamalog-app
```

## ✅ 운영환경 동일성 검증

### 확인해야 할 항목들

1. **Spring Profile**: `prod` 프로필 활성화 확인
2. **데이터베이스**: MySQL 8.0 사용 확인
3. **캐싱**: Redis 연결 확인
4. **보안 헤더**: 프로덕션 보안 헤더 적용 확인
5. **로깅**: 구조화된 JSON 로그 출력 확인
6. **성능 모니터링**: JVM 메트릭 및 성능 로그 확인
7. **암호화**: 데이터 암호화 기능 확인

### 검증 명령어

```bash
# 1. 프로필 확인 (로그에서 SPRING_PROFILES_ACTIVE=prod 확인)
docker logs hamalog-hamalog-app-1 | grep "Active profiles"

# 2. 보안 헤더 확인
curl -I http://localhost:8080 | grep -E "(X-Content-Type-Options|X-Frame-Options|Content-Security-Policy)"

# 3. 데이터베이스 연결 확인
docker exec hamalog-mysql-hamalog-1 mysql -u hamalog_user -p -e "SHOW DATABASES;"

# 4. Redis 연결 확인
docker exec hamalog-redis-1 redis-cli ping

# 5. Vault 연결 확인
docker exec hamalog-vault-local vault status
```

## 📝 운영환경과의 차이점

### 동일한 부분
- ✅ Spring Profile: `prod` 사용
- ✅ 데이터베이스: MySQL 8.0
- ✅ 캐싱: Redis 7
- ✅ 보안 키 관리: HashiCorp Vault
- ✅ 보안 설정: 프로덕션 보안 헤더
- ✅ 로깅: 구조화된 로그
- ✅ 성능 모니터링: JVM 메트릭
- ✅ 연결 풀링: HikariCP 설정
- ✅ 암호화: AES 데이터 암호화

### 차이점 (로컬 개발용 조정)
- 🔧 **헬스 체크 간격**: 더 빠른 간격 (10초 vs 30초)
- 🔧 **로그 볼륨**: 로컬 디렉토리에 마운트
- 🔧 **네트워크**: Docker 내부 네트워크 사용
- 🔧 **SSL/TLS**: 로컬에서는 HTTP 사용 (운영에서는 HTTPS)

## 🎯 사용 시나리오

### 1. 새 기능 개발 후 테스트
```bash
# 1. 코드 변경 후 빌드
./gradlew build

# 2. 운영환경 동일 로컬 환경에서 테스트
./run-production-local.sh clean
./run-production-local.sh start

# 3. 기능 테스트 수행
# 4. 문제 없으면 GitHub에 푸시
```

### 2. 데이터베이스 스키마 변경 테스트
```bash
# 1. 운영환경 동일 환경 시작
./run-production-local.sh start

# 2. 마이그레이션 테스트
# 3. 데이터 무결성 확인
```

### 3. 보안 설정 변경 테스트
```bash
# 1. Vault 설정 변경
# 2. 애플리케이션 재시작
./run-production-local.sh restart

# 3. 보안 기능 테스트
```

## 📞 추가 도움

문제가 지속되는 경우:
1. GitHub Issues에 문제 상황 공유
2. `./run-production-local.sh logs` 결과 첨부
3. `docker ps -a` 및 `docker logs` 결과 포함

---

**중요**: 이 환경은 운영환경과 거의 동일하지만 로컬 개발용으로 최적화되어 있습니다. 실제 운영 배포 전에는 반드시 이 환경에서 충분한 테스트를 수행하세요.

**보안 주의사항**: `.env.prod-local` 파일의 패스워드는 개발용입니다. 실제 운영환경에서는 더 강력한 패스워드를 사용하세요.