name: Deploy to Production on Main Push

# Trigger this workflow when code is pushed to the main branch
on:
  push:
    branches:
      - main
  # Allow manual triggering from GitHub UI
  workflow_dispatch:

# Set environment variables that can be used across all jobs
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy Hamalog Application
    runs-on: ubuntu-latest
    
    # Required permissions for the workflow
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
            
      - name: Make gradlew executable
        run: chmod +x ./gradlew
        
      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@v3
        continue-on-error: true
        timeout-minutes: 5
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            
      - name: Build and test application
        run: |
          echo "üî® Building and testing the application..."
          ./gradlew clean build
          
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: Deploy to production server
        run: |
          echo "üöÄ Starting deployment process..."
          
          # Make deploy script executable (redundant but safe)
          chmod +x ./deploy.sh
          
          # Set environment variables for production deployment
          export SPRING_PROFILES_ACTIVE=prod
          export JWT_SECRET="${{ secrets.JWT_SECRET }}"
          export JWT_EXPIRY="${{ secrets.JWT_EXPIRY || '3600000' }}"
          export KAKAO_CLIENT_ID="${{ secrets.KAKAO_CLIENT_ID }}"
          export KAKAO_CLIENT_SECRET="${{ secrets.KAKAO_CLIENT_SECRET }}"
          export MYSQL_ROOT_PASSWORD="${{ secrets.MYSQL_ROOT_PASSWORD }}"
          export DB_NAME="${{ secrets.DB_NAME || 'Hamalog' }}"
          export DB_USERNAME="${{ secrets.DB_USERNAME || 'hamalog_user' }}"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD || 'hamalog_password' }}"
          
          # Run the deployment script
          ./deploy.sh
          
      - name: Post-deployment verification
        run: |
          echo "‚úÖ Verifying deployment..."
          
          # Wait for application to fully start
          sleep 30
          
          # Check if containers are running
          docker-compose -p hamalog ps
          
          # Try to connect to the application (basic connectivity test)
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt: Testing application connectivity..."
            
            if curl -f -s -m 10 http://localhost:8080/ >/dev/null 2>&1 || \
               curl -f -s -m 10 http://localhost:8080/actuator/health >/dev/null 2>&1; then
              echo "‚úÖ Application is responding successfully!"
              break
            fi
            
            if [ $attempt -eq $max_attempts ]; then
              echo "‚ùå Application health check failed after $max_attempts attempts"
              echo "üìã Application logs:"
              docker-compose -p hamalog logs hamalog-app --tail=100
              exit 1
            fi
            
            echo "‚è≥ Waiting 10 seconds before next attempt..."
            sleep 10
            attempt=$((attempt + 1))
          done
          
      - name: Cleanup old Docker images
        run: |
          echo "üßπ Cleaning up old Docker images to save disk space..."
          
          # Remove dangling images
          docker image prune -f || true
          
          # Keep only the 3 most recent images of this repository
          docker images ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} --format "{{.ID}} {{.CreatedAt}}" | \
            sort -k2 -r | tail -n +4 | awk '{print $1}' | xargs -r docker rmi || true
            
      - name: Send deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "üéâ Deployment completed successfully!"
            echo "‚úÖ Hamalog application is now running with the latest changes from main branch"
            echo "üåê Application URL: http://localhost:8080"
          else
            echo "‚ùå Deployment failed!"
            echo "üîç Check the logs above for error details"
          fi