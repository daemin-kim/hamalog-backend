name: ë©”ì¸ ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ í”„ë¡œë•ì…˜ ë°°í¬

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Java 21 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Gradle íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
        run: ./gradlew clean build

      - name: ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Hamalog ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
    permissions:
      contents: read
      packages: read
    env:
      SPRING_PROFILES_ACTIVE: prod
      MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      JWT_EXPIRY: ${{ secrets.JWT_EXPIRY }}
      KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
      KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
      CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: í•„ìˆ˜ ì‹œí¬ë¦¿ ê²€ì¦
        run: |
          set -euo pipefail
          missing=0
          for var in MYSQL_ROOT_PASSWORD DB_NAME DB_USERNAME DB_PASSWORD JWT_SECRET JWT_EXPIRY KAKAO_CLIENT_ID KAKAO_CLIENT_SECRET CLOUDFLARE_TUNNEL_TOKEN; do
            if [ -z "${!var:-}" ]; then
              echo "::error::í•„ìˆ˜ ì‹œí¬ë¦¿ ${var} ê°’ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then
            exit 1
          fi

      - name: docker-compose.prod.yml ìƒì„±
        run: |
          cat <<'EOF' > docker-compose.prod.yml
          services:
            # ===== Cloudflare Tunnel (ë³´ì•ˆ í„°ë„ ì—°ê²°) =====
            # ì™¸ë¶€ íŠ¸ë˜í”½ì€ Cloudflareë¥¼ í†µí•´ì„œë§Œ ë“¤ì–´ì˜´
            # ì§‘ IP ë…¸ì¶œ ì—†ì´ ì•ˆì „í•˜ê²Œ ì„œë¹„ìŠ¤ ì œê³µ (DDoS ë°©ì–´)
            tunnel:
              image: cloudflare/cloudflared:latest
              container_name: cloudflare-tunnel
              restart: unless-stopped
              command: tunnel run
              environment:
                - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
              depends_on:
                - nginx
              networks:
                - default

            nginx:
              image: nginx:alpine
              container_name: nginx-hamalog
              # ë³´ì•ˆ: ì™¸ë¶€ í¬íŠ¸ ë…¸ì¶œ ì œê±° - Cloudflare Tunnelì„ í†µí•´ì„œë§Œ ì ‘ê·¼
              expose:
                - "80"
              volumes:
                - ./nginx-docker.conf:/etc/nginx/conf.d/default.conf:ro
              depends_on:
                - hamalog-app
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/actuator/health"]
                interval: 30s
                timeout: 10s
                start_period: 60s
                retries: 3

            hamalog-app:
              image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
              # ë³´ì•ˆ: ì™¸ë¶€ ë…¸ì¶œ ëŒ€ì‹  ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì—ì„œë§Œ Nginxë¥¼ í†µí•´ ì ‘ê·¼
              expose:
                - "8080"
              environment:
                - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
                - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-hamalog:3306/${DB_NAME}
                - SPRING_DATASOURCE_USERNAME=${DB_USERNAME}
                - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
                - SPRING_DATA_REDIS_HOST=redis
                - SPRING_DATA_REDIS_PORT=6379
                - JWT_SECRET=${JWT_SECRET}
                - JWT_EXPIRY=${JWT_EXPIRY}
                - KAKAO_CLIENT_ID=${KAKAO_CLIENT_ID}
                - KAKAO_CLIENT_SECRET=${KAKAO_CLIENT_SECRET}
              depends_on:
                mysql-hamalog:
                  condition: service_healthy
                redis:
                  condition: service_healthy
              restart: unless-stopped

            redis:
              image: redis:7-alpine
              # ë³´ì•ˆ: ì™¸ë¶€ ë…¸ì¶œ ëŒ€ì‹  ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì—ì„œë§Œ ì ‘ê·¼
              expose:
                - "6379"
              command: redis-server --appendonly yes
              volumes:
                - redis-data:/data
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "redis-cli", "ping"]
                interval: 30s
                timeout: 10s
                retries: 3

            mysql-hamalog:
              image: mysql:8.0
              # ë³´ì•ˆ: ì™¸ë¶€ ë…¸ì¶œ ëŒ€ì‹  ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì—ì„œë§Œ ì ‘ê·¼
              expose:
                - "3306"
              environment:
                - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
                - MYSQL_DATABASE=${DB_NAME}
                - MYSQL_USER=${DB_USERNAME}
                - MYSQL_PASSWORD=${DB_PASSWORD}
              volumes:
                - mysql-data:/var/lib/mysql
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
                interval: 30s
                timeout: 10s
                retries: 3

          volumes:
            mysql-data:
            redis-data:
          EOF

      - name: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
        run: docker compose -p hamalog -f docker-compose.prod.yml down --remove-orphans || true

      - name: ìµœì‹  ì´ë¯¸ì§€ Pull
        run: docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Nginx ì„¤ì • íŒŒì¼ ë³µì‚¬
        run: |
          # nginx-docker.conf íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ë³µì‚¬
          if [ -f "nginx-docker.conf" ]; then
            echo "nginx-docker.conf found, using it"
          else
            echo "Creating nginx-docker.conf for production"
            cat <<'NGINXEOF' > nginx-docker.conf
          # Simple Nginx configuration for Docker Compose
          limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
          limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/m;
          limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

          map $http_user_agent $bad_bot {
              default 0;
              ~*l9scan 1;
              ~*leakix 1;
              ~*zgrab 1;
              ~*nuclei 1;
              ~*nikto 1;
              ~*sqlmap 1;
              ~*masscan 1;
              ~*nmap 1;
              ~*censys 1;
              ~*shodan 1;
          }

          map $uri $blocked_path {
              default 0;
              ~*\.env 1;
              ~*\.git 1;
              ~*wp-admin 1;
              ~*phpmyadmin 1;
          }

          upstream hamalog_backend {
              server hamalog-app:8080;
              keepalive 32;
          }

          server {
              listen 80;
              server_name _;

              add_header X-Frame-Options "DENY" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header X-XSS-Protection "1; mode=block" always;
              add_header Referrer-Policy "strict-origin-when-cross-origin" always;

              limit_conn conn_limit 20;
              client_body_timeout 10s;
              client_header_timeout 10s;
              send_timeout 10s;

              if ($bad_bot) { return 403; }
              if ($blocked_path) { return 403; }

              location /actuator/health {
                  proxy_pass http://hamalog_backend;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  access_log off;
              }

              location / {
                  limit_req zone=api_limit burst=20 nodelay;
                  proxy_pass http://hamalog_backend;
                  proxy_http_version 1.1;
                  proxy_set_header Connection "";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  client_max_body_size 10M;
              }
          }
          NGINXEOF
          fi

      - name: ì„œë¹„ìŠ¤ ì‹œì‘
        run: docker compose -p hamalog -f docker-compose.prod.yml up -d

      - name: ë°°í¬ í™•ì¸
        run: |
          echo "ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸"
          docker compose -p hamalog -f docker-compose.prod.yml ps
          attempts=15
          for i in $(seq 1 $attempts); do
            # Docker ë„¤íŠ¸ì›Œí¬ ë‚´ë¶€ì—ì„œ í—¬ìŠ¤ì²´í¬ (Nginx ì»¨í…Œì´ë„ˆë¥¼ í†µí•´)
            if docker exec nginx-hamalog wget -q --spider http://localhost/actuator/health 2>/dev/null; then
              echo "ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ì„±ê³µ (via Nginx container)"
              exit 0
            fi
            # hamalog-app ì»¨í…Œì´ë„ˆ ì§ì ‘ í™•ì¸ (fallback)
            if docker exec hamalog-hamalog-app-1 wget -q --spider http://localhost:8080/actuator/health 2>/dev/null; then
              echo "ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ì„±ê³µ (via App container)"
              exit 0
            fi
            echo "ì¬ì‹œë„ ${i}/${attempts}"
            sleep 10
          done
          echo "ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          docker compose -p hamalog -f docker-compose.prod.yml logs --tail=50
          exit 1

      - name: ì •ë¦¬ ì‘ì—…
        if: always()
        run: |
          rm -f docker-compose.prod.yml
          # nginx-docker.confëŠ” ì €ì¥ì†Œì—ì„œ ì²´í¬ì•„ì›ƒí•œ ê²½ìš° ì‚­ì œí•˜ì§€ ì•ŠìŒ
          docker image prune -f || true

      - name: ë°°í¬ ì•Œë¦¼
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ğŸŒ ì• í”Œë¦¬ì¼€ì´ì…˜ URL: https://api.hamalog.shop"
            echo "ğŸ”’ Cloudflare Tunnelì„ í†µí•´ ì•ˆì „í•˜ê²Œ ì„œë¹„ìŠ¤ë©ë‹ˆë‹¤."
          else
            echo "âŒ ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"
          fi