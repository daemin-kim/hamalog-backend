# Hamalog ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ë³´ê³ ì„œ

## ğŸ“… í…ŒìŠ¤íŠ¸ ì •ë³´
- **ë‚ ì§œ**: 2026ë…„ 1ì›” 16ì¼
- **í™˜ê²½**: Docker ë¡œì»¬ ë²¤ì¹˜ë§ˆí¬ í™˜ê²½ (ë°°ì¹˜ íŒ¨ì¹˜ ë¹„í™œì„±í™”)
- **í…ŒìŠ¤íŠ¸ ëª©ì **: JPA N+1 ë¬¸ì œ í•´ê²° ì „/í›„ ì„±ëŠ¥ ë¹„êµ

---

## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½

### í…ŒìŠ¤íŠ¸ ë°ì´í„° ê·œëª¨
| í•­ëª© | ê°œìˆ˜ |
|------|-----|
| **Member** | 1ëª… |
| **MedicationSchedule** | 1,000ê°œ |
| **MedicationTime** | 3,000ê°œ (ê° ìŠ¤ì¼€ì¤„ë‹¹ 3ê°œ) |

### ğŸ”¥ ì„±ëŠ¥ ì¸¡ì • ê²°ê³¼ (10íšŒ ì¸¡ì •)

| ë°©ì‹ | í‰ê·  ì‘ë‹µì‹œê°„ | ìµœì†Œ | ìµœëŒ€ | **ê°œì„ ìœ¨** |
|------|-------------|------|------|-----------|
| **ìµœì í™” (JOIN FETCH)** | **46ms** | 37ms | 90ms | - |
| **ë¹„ìµœì í™” (N+1)** | **297ms** | 153ms | 649ms | - |
| **ì„±ëŠ¥ ê°œì„ ** | - | - | - | **ğŸš€ 6.5ë°°** |

### ğŸ” ì¿¼ë¦¬ ìˆ˜ ë¹„êµ (Hibernate Statistics)

| ë°©ì‹ | JDBC ì¿¼ë¦¬ ìˆ˜ | DB ì‹¤í–‰ ì‹œê°„ | **ì¿¼ë¦¬ ê°ì†Œìœ¨** |
|------|-------------|-------------|----------------|
| **ìµœì í™”** | **2ê°œ** | 14ms | - |
| **ë¹„ìµœì í™”** | **1,003ê°œ** | 213ms | - |
| **ê°œì„ ** | - | - | **ğŸš€ 501.5ë°° ê°ì†Œ** |

> ğŸ“Œ ë¹„ìµœì í™” ì‹œ: 1(ë©¤ë²„ í™•ì¸) + 1(ìŠ¤ì¼€ì¤„ ëª©ë¡) + 1,000(ê° ìŠ¤ì¼€ì¤„ì˜ MedicationTime) + 1(ì¶”ê°€ ì¿¼ë¦¬) = **1,003ê°œ ì¿¼ë¦¬**

---

## ğŸ“ˆ ì„±ëŠ¥ ê°œì„  ì‹œê°í™”

```
ì‘ë‹µì‹œê°„ ë¹„êµ (ms)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ìµœì í™” (JOIN FETCH)                                          â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 46ms                                                â”‚
â”‚                                                              â”‚
â”‚ ë¹„ìµœì í™” (N+1)                                               â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 297ms     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì¿¼ë¦¬ ìˆ˜ ë¹„êµ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ìµœì í™”: 2ê°œ                                                  â”‚
â”‚ â–®â–®                                                          â”‚
â”‚                                                              â”‚
â”‚ ë¹„ìµœì í™”: 1,003ê°œ                                            â”‚
â”‚ â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–®â–® (...)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”¬ ê¸°ìˆ ì  ë¶„ì„

### N+1 ë¬¸ì œë€?
```java
// âŒ N+1 ë¬¸ì œ ë°œìƒ ì½”ë“œ
List<MedicationSchedule> schedules = repository.findAllByMemberId(memberId);
for (Schedule schedule : schedules) {
    // ê° ìŠ¤ì¼€ì¤„ë§ˆë‹¤ ì¶”ê°€ ì¿¼ë¦¬ ë°œìƒ!
    List<MedicationTime> times = schedule.getMedicationTimes(); 
}
// ê²°ê³¼: 1 + Nê°œì˜ ì¿¼ë¦¬ (N = ìŠ¤ì¼€ì¤„ ê°œìˆ˜)
```

### í•´ê²°: JOIN FETCH ì‚¬ìš©
```java
// âœ… ìµœì í™”ëœ ì½”ë“œ (@EntityGraph ë˜ëŠ” JOIN FETCH)
@Query("SELECT DISTINCT ms FROM MedicationSchedule ms " +
       "LEFT JOIN FETCH ms.medicationTimes " +
       "WHERE ms.member.memberId = :memberId")
List<MedicationSchedule> findAllOptimized(@Param("memberId") Long memberId);
// ê²°ê³¼: ë‹¨ 1ê°œì˜ ì¿¼ë¦¬ë¡œ ëª¨ë“  ë°ì´í„° ì¡°íšŒ
```

### ë²¤ì¹˜ë§ˆí¬ í™˜ê²½ ì„¤ì •
```yaml
# application-benchmark.yml
spring.jpa.properties.hibernate:
  default_batch_fetch_size: 1  # ë°°ì¹˜ íŒ¨ì¹˜ ë¹„í™œì„±í™” (ìˆœìˆ˜ N+1 ë°œìƒ)
  generate_statistics: true     # ì¿¼ë¦¬ í†µê³„ ìˆ˜ì§‘
```

---

## ğŸ’¡ í•µì‹¬ ê²°ë¡ 

### 1. N+1 ë¬¸ì œì˜ ì‹¤ì œ ì˜í–¥
- **1,000ê°œ ë ˆì½”ë“œì—ì„œ 6.5ë°° ì„±ëŠ¥ ì €í•˜**
- ë°ì´í„°ê°€ ì¦ê°€í• ìˆ˜ë¡ ì„±ëŠ¥ ì €í•˜ ì‹¬í™”
- í”„ë¡œë•ì…˜ì—ì„œëŠ” ë„¤íŠ¸ì›Œí¬ ì§€ì—°ìœ¼ë¡œ ë” ì‹¬ê°

### 2. í•´ê²° ë°©ë²• (ìš°ì„ ìˆœìœ„)
1. **@EntityGraph / JOIN FETCH** (ê¶Œì¥)
   - ëª…ì‹œì ì´ê³  ì˜ˆì¸¡ ê°€ëŠ¥
   - ì¿¼ë¦¬ ìˆ˜ê°€ í•­ìƒ ì¼ì •
   
2. **default_batch_fetch_size** (ë³´ì¡°)
   - ì „ì—­ ì„¤ì •ìœ¼ë¡œ N+1 ì™„í™”
   - ì™„ì „í•œ í•´ê²°ì±…ì€ ì•„ë‹˜

3. **DTO Projection** (ê³ ê¸‰)
   - í•„ìš”í•œ í•„ë“œë§Œ ì¡°íšŒ
   - ì¶”ê°€ ìµœì í™” ê°€ëŠ¥

### 3. ì‹¤ë¬´ ê¶Œì¥ì‚¬í•­
- **ê°œë°œ ì¤‘ Hibernate Statistics í™œì„±í™”**ë¡œ N+1 ì¡°ê¸° ë°œê²¬
- **ìƒˆ ê¸°ëŠ¥ ì¶”ê°€ ì‹œ ì¿¼ë¦¬ ë¡œê·¸ í™•ì¸** ìŠµê´€í™”
- **ì •ê¸° ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬**ë¡œ íšŒê·€ ë°©ì§€

---

## ğŸ”§ í…ŒìŠ¤íŠ¸ ì¬í˜„ ë°©ë²•

### 1. ë²¤ì¹˜ë§ˆí¬ í™˜ê²½ ì‹œì‘
```bash
cd /Users/daeminkim/ideaProjects/Hamalog
docker-compose -f docker-compose-benchmark.yml up -d --build
sleep 60  # ë°ì´í„° ìƒì„± ëŒ€ê¸°
```

### 2. ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
```bash
# ìµœì í™” ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸ (10íšŒ)
for i in {1..10}; do
  curl -s -w "%{time_total}s\n" -o /dev/null \
    "http://localhost:8080/api/v1/benchmark/medication-schedules/list/1?optimized=true"
done

# ë¹„ìµœì í™” ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸ (10íšŒ)
for i in {1..10}; do
  curl -s -w "%{time_total}s\n" -o /dev/null \
    "http://localhost:8080/api/v1/benchmark/medication-schedules/list/1?optimized=false"
done
```

### 3. ì¿¼ë¦¬ ìˆ˜ í™•ì¸
```bash
# Hibernate Session Metrics ë¡œê·¸ í™•ì¸
docker-compose -f docker-compose-benchmark.yml logs app --tail=30 | grep "JDBC statements"
```

### 4. í™˜ê²½ ì¢…ë£Œ
```bash
docker-compose -f docker-compose-benchmark.yml down -v
```

---

## ğŸ“ ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì„¤ëª… |
|------|------|
| `docker-compose-benchmark.yml` | ë²¤ì¹˜ë§ˆí¬ Docker í™˜ê²½ |
| `src/main/resources/application-benchmark.yml` | ë²¤ì¹˜ë§ˆí¬ í”„ë¡œíŒŒì¼ (ë°°ì¹˜ íŒ¨ì¹˜ ë¹„í™œì„±í™”) |
| `src/main/java/com/Hamalog/config/benchmark/BenchmarkDataInitializer.java` | 1,000ê°œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìë™ ìƒì„± |
| `src/main/java/com/Hamalog/service/benchmark/BenchmarkService.java` | ë²¤ì¹˜ë§ˆí¬ ì„œë¹„ìŠ¤ |
| `src/main/java/com/Hamalog/controller/benchmark/BenchmarkController.java` | ë²¤ì¹˜ë§ˆí¬ API |

---

## âœ… í”„ë¡œì íŠ¸ì— ì ìš©ëœ ìµœì í™”

### MedicationScheduleRepository.java
```java
// ìµœì í™”ëœ ì¿¼ë¦¬ (N+1 í•´ê²°)
@EntityGraph(attributePaths = {"medicationTimes", "member"})
@Query("SELECT DISTINCT ms FROM MedicationSchedule ms " +
       "WHERE ms.member.memberId = :memberId")
List<MedicationSchedule> findAllByMember_MemberId(@Param("memberId") Long memberId);
```

### application.yml (í”„ë¡œë•ì…˜)
```yaml
# ë°±ì—… ì•ˆì „ë§ìœ¼ë¡œ ë°°ì¹˜ íŒ¨ì¹˜ ìœ ì§€
spring.jpa.properties.hibernate.default_batch_fetch_size: 100
```

---

## ğŸ† ê²°ë¡ 

**JPA N+1 ë¬¸ì œ í•´ê²°ë¡œ 6.5ë°° ì„±ëŠ¥ í–¥ìƒ ë° 501.5ë°° ì¿¼ë¦¬ ìˆ˜ ê°ì†Œ ë‹¬ì„±**

ì´ ë²¤ì¹˜ë§ˆí¬ëŠ” ì‹¤ì œ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” N+1 ë¬¸ì œì˜ ì‹¬ê°ì„±ê³¼ 
@EntityGraph/JOIN FETCHë¥¼ í†µí•œ í•´ê²° ë°©ë²•ì˜ íš¨ê³¼ë¥¼ ì •ëŸ‰ì ìœ¼ë¡œ ì¦ëª…í•©ë‹ˆë‹¤.
