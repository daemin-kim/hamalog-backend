name: Deploy to Production on Main Push

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant gradlew execution permission
        run: chmod +x ./gradlew

      - name: Build application
        run: ./gradlew clean build -x test

      - name: Login to container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to On-Premise Server
    runs-on: self-hosted
    needs: build
    environment:
      name: production
    env:
      MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      JWT_EXPIRY: ${{ secrets.JWT_EXPIRY }}
      JWT_REFRESH_TOKEN_EXPIRY: ${{ secrets.JWT_REFRESH_TOKEN_EXPIRY }}
      KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
      KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
      KAKAO_REDIRECT_URI: ${{ secrets.KAKAO_REDIRECT_URI }}
      CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      SPRING_DATA_REDIS_PASSWORD: ${{ secrets.SPRING_DATA_REDIS_PASSWORD }}
      HAMALOG_ENCRYPTION_KEY: ${{ secrets.HAMALOG_ENCRYPTION_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate docker-compose.prod.yml
        shell: powershell
        run: |
          @"
          services:
            tunnel:
              image: cloudflare/cloudflared:latest
              container_name: cloudflare-tunnel
              restart: unless-stopped
              command: tunnel run
              environment:
                - TUNNEL_TOKEN=${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
              depends_on:
                - nginx
              networks:
                - hamalog-network

            nginx:
              image: nginx:alpine
              container_name: nginx-hamalog
              expose:
                - "80"
              volumes:
                - ./nginx-docker.conf:/etc/nginx/conf.d/default.conf:ro
              depends_on:
                - hamalog-app
              networks:
                - hamalog-network
              restart: unless-stopped

            hamalog-app:
              image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
              container_name: hamalog-app
              expose:
                - "8080"
              environment:
                - SPRING_PROFILES_ACTIVE=prod
                - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-hamalog:3306/${{ secrets.DB_NAME }}?useSSL=true&requireSSL=true&characterEncoding=UTF-8&serverTimezone=UTC
                - SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USERNAME }}
                - SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}
                - SPRING_DATA_REDIS_HOST=hamalog-redis
                - SPRING_DATA_REDIS_PORT=6379
                - SPRING_DATA_REDIS_PASSWORD=${{ secrets.SPRING_DATA_REDIS_PASSWORD }}
                - JWT_SECRET=${{ secrets.JWT_SECRET }}
                - JWT_EXPIRY=${{ secrets.JWT_EXPIRY }}
                - JWT_REFRESH_TOKEN_EXPIRY=${{ secrets.JWT_REFRESH_TOKEN_EXPIRY }}
                - HAMALOG_ENCRYPTION_KEY=${{ secrets.HAMALOG_ENCRYPTION_KEY }}
                - KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
                - KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}
                - KAKAO_REDIRECT_URI=${{ secrets.KAKAO_REDIRECT_URI }}
                - FRONTEND_URL=https://api.hamalog.shop
                - ALLOWED_ORIGINS=https://api.hamalog.shop,http://localhost:3000
              volumes:
                - hamalog-uploads:/data/hamalog/images
              depends_on:
                mysql-hamalog:
                  condition: service_healthy
                hamalog-redis:
                  condition: service_healthy
              networks:
                - hamalog-network
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
                interval: 30s
                timeout: 10s
                start_period: 60s
                retries: 5

            hamalog-redis:
              image: redis:7-alpine
              container_name: hamalog-redis
              expose:
                - "6379"
              command: redis-server --requirepass ${{ secrets.SPRING_DATA_REDIS_PASSWORD }} --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
              volumes:
                - redis-data:/data
              networks:
                - hamalog-network
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${{ secrets.SPRING_DATA_REDIS_PASSWORD }}", "ping"]
                interval: 30s
                timeout: 10s
                retries: 3

            mysql-hamalog:
              image: mysql:8.0
              container_name: mysql-hamalog
              expose:
                - "3306"
              ports:
                - "127.0.0.1:3306:3306"
              environment:
                - MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
                - MYSQL_DATABASE=${{ secrets.DB_NAME }}
                - MYSQL_USER=${{ secrets.DB_USERNAME }}
                - MYSQL_PASSWORD=${{ secrets.DB_PASSWORD }}
              volumes:
                - mysql-data:/var/lib/mysql
              networks:
                - hamalog-network
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${{ secrets.MYSQL_ROOT_PASSWORD }}"]
                interval: 30s
                timeout: 10s
                retries: 3

          networks:
            hamalog-network:
              driver: bridge

          volumes:
            mysql-data:
            redis-data:
            hamalog-uploads:
          "@ | Out-File -FilePath docker-compose.prod.yml -Encoding utf8

      - name: Cleanup existing containers
        shell: powershell
        run: |
          $ErrorActionPreference = "SilentlyContinue"
          Write-Host "=== Cleaning up existing containers ==="
          
          # 1. Stop and remove ALL containers from previous hamalog deployments
          # This includes both current naming and legacy naming patterns
          $containers = @(
            "cloudflare-tunnel", 
            "nginx-hamalog", 
            "hamalog-app", 
            "hamalog-redis", 
            "mysql-hamalog",
            # Legacy container names from old deployment
            "hamalog-container",
            "redis-hamalog",
            "redis",
            "nginx",
            "tunnel"
          )
          foreach ($container in $containers) {
            $exists = docker ps -a --format "{{.Names}}" 2>$null | Select-String -Pattern "^$container$" -Quiet
            if ($exists) {
              Write-Host "Removing container: $container"
              docker rm -f $container 2>$null | Out-Null
            }
          }
          
          # 2. Also remove any containers with hamalog prefix (catch-all)
          docker ps -a --format "{{.Names}}" 2>$null | ForEach-Object {
            if ($_ -match "hamalog" -or $_ -match "Hamalog") {
              Write-Host "Removing hamalog-related container: $_"
              docker rm -f $_ 2>$null | Out-Null
            }
          }
          
          # 3. Try to clean up old project containers via compose
          docker compose -p hamalog -f docker-compose.prod.yml down --remove-orphans 2>$null | Out-Null
          
          # 4. Clean up old networks (ignore errors)
          docker network rm hamalog-network 2>$null | Out-Null
          docker network rm hamalog_hamalog-network 2>$null | Out-Null
          
          Write-Host "=== Cleanup complete ==="
          
          # Explicitly return success
          exit 0

      - name: Pull latest image
        shell: powershell
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Start services
        shell: powershell
        run: |
          docker compose -p hamalog -f docker-compose.prod.yml up -d

      - name: Verify deployment
        shell: powershell
        run: |
          Write-Host "Checking container status"
          docker compose -p hamalog -f docker-compose.prod.yml ps
          
          $attempts = 20
          for ($i = 1; $i -le $attempts; $i++) {
            # Health check directly from hamalog-app container
            $result = docker exec hamalog-app curl -sf http://localhost:8080/actuator/health 2>$null
            if ($LASTEXITCODE -eq 0) {
              Write-Host "OK: Application health check passed!"
              docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
              exit 0
            }
            Write-Host "Retry $i/$attempts..."
            Start-Sleep -Seconds 10
          }
          
          Write-Host "FAILED: Application health check failed"
          docker compose -p hamalog -f docker-compose.prod.yml logs --tail=100
          exit 1

      - name: Cleanup
        if: always()
        shell: powershell
        run: |
          Remove-Item -Path docker-compose.prod.yml -Force -ErrorAction SilentlyContinue
          docker image prune -f 2>$null

      - name: Deployment notification
        if: always()
        shell: powershell
        run: |
          if ("${{ job.status }}" -eq "success") {
            Write-Host "SUCCESS: Deployment completed successfully!"
            Write-Host "URL: https://api.hamalog.shop"
            Write-Host "Secured via Cloudflare Tunnel"
          } else {
            Write-Host "FAILED: Deployment failed!"
          }
