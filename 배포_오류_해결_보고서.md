# Hamalog 배포 오류 해결 보고서

## 발생한 문제

### 1. 주요 오류 메시지
```
hamalog-app Error manifest unknown
Error response from daemon: manifest unknown
❌ Deployment failed with exit code: 1
```

### 2. 문제 상황
- GitHub Actions를 통한 Docker 이미지 빌드는 성공
- 하지만 배포 단계에서 Docker 이미지를 찾을 수 없어 실패
- `ghcr.io/daemin-kim/hamalog-backend:668954c5c0232cdf94abdf6e8198cb99673548ca` 이미지를 pull할 수 없음

## 문제 원인 분석

### 1. 이미지명 불일치 문제 (1차 해결)
- **GitHub Actions에서 빌드되는 이미지**: `ghcr.io/daemin-kim/hamalog-backend:태그`
- **배포 스크립트에서 찾는 이미지**: `ghcr.io/hamalog:태그`
- deploy.sh에서 `IMAGE_NAME="${REGISTRY}/${GITHUB_REPOSITORY:-hamalog}"`로 설정되어 있었지만, GITHUB_REPOSITORY 환경변수가 전달되지 않아 기본값 "hamalog"가 사용됨

### 2. Docker 이미지 태깅 불일치 문제 (2차 발견)
- **GitHub Actions metadata-action 생성 태그**: `main-453a6545b97fe240727c378291230abeb793d851`
- **배포 스크립트에서 기대하는 태그**: `453a6545b97fe240727c378291230abeb793d851`
- metadata-action의 `type=sha,prefix={{branch}}-` 설정으로 인해 브랜치 prefix가 추가되어 태그 불일치 발생

### 3. Docker Compose 버전 경고
- `docker-compose.yml`과 배포 스크립트에서 생성되는 `docker-compose.prod.yml`에서 `version: '3.8'` 속성 사용
- 최신 Docker Compose에서는 해당 속성이 deprecated되어 경고 메시지 발생

### 4. 환경변수 전달 누락
- GitHub Actions에서 deploy.sh로 GITHUB_REPOSITORY와 GITHUB_SHA 환경변수가 제대로 전달되지 않음

### 5. 배포 실패 시 디버깅 정보 부족
- 이미지 pull 실패 원인을 정확히 파악하기 어려운 로그 구조
- 레지스트리 인증 상태 및 이미지 존재 여부 사전 확인 부족

## 해결 방안

### 1. 이미지명 불일치 해결 (1차)
**수정 전:**
```bash
IMAGE_NAME="${REGISTRY}/${GITHUB_REPOSITORY:-hamalog}"
```

**수정 후:**
```bash
IMAGE_NAME="${REGISTRY}/${GITHUB_REPOSITORY:-daemin-kim/hamalog-backend}"
```
- 기본값을 실제 리포지토리명으로 변경하여 환경변수가 없어도 올바른 이미지명 사용

### 2. Docker 이미지 태깅 불일치 해결 (2차 - 핵심 문제)
**문제**: GitHub Actions metadata-action이 `main-453a6545...` 형태의 태그를 생성하지만, deploy.sh는 `453a6545...` 형태를 기대

**수정 전:**
```
tags: |
  type=ref,event=branch
  type=ref,event=pr
  type=sha,prefix={{branch}}-
  type=raw,value=latest,enable={{is_default_branch}}
```

**수정 후:**
```
tags: |
  type=sha
  type=raw,value=latest,enable={{is_default_branch}}
```
- 브랜치 prefix 제거하여 deploy.sh에서 기대하는 태그 형식과 일치시킴
- 불필요한 ref 태그들 제거로 태그 생성 단순화

### 3. GitHub Actions 환경변수 및 검증 강화
GitHub Actions workflow에 다음 기능 추가:
- 환경변수 명시적 설정
- 이미지 존재 여부 사전 검증
- 상세한 디버깅 정보 제공
- Container Registry API를 통한 태그 목록 확인

### 4. 배포 스크립트 이미지 pull 로직 개선
deploy.sh에 다음 기능 추가:
- `docker manifest inspect`를 통한 레지스트리 이미지 존재 여부 사전 확인
- 실패 시 'latest' 태그로 자동 fallback 기능
- 상세한 디버깅 정보 제공 (로컬 이미지 목록, 레지스트리 상태 등)
- 이미지 pull 실패 시 더 구체적인 오류 메시지

### 5. Docker Compose 버전 경고 해결
- `docker-compose.yml`에서 `version: '3.8'` 제거
- `deploy.sh`에서 생성하는 `docker-compose.prod.yml`에서도 version 속성 제거

## 수정 사항 요약

### 파일별 변경사항

1. **deploy.sh**
   - IMAGE_NAME 기본값을 'hamalog'에서 'daemin-kim/hamalog-backend'로 변경
   - 생성되는 docker-compose.prod.yml에서 version 속성 제거
   - 이미지 pull 로직 대폭 개선 (manifest inspect, fallback 기능, 상세 디버깅)

2. **docker-compose.yml**
   - deprecated version 속성 제거

3. **.github/workflows/deploy-main.yml**
   - GITHUB_REPOSITORY와 GITHUB_SHA 환경변수 명시적 추가
   - metadata-action 태그 설정 수정 (`type=sha,prefix={{branch}}-` → `type=sha`)
   - Docker 레지스트리 접근 상태 검증 로직 추가
   - 이미지 존재 여부 사전 확인 및 디버깅 정보 강화

## 기대 효과

### 1. 근본적인 배포 성공
- **핵심**: Docker 이미지 태그 불일치 문제 완전 해결
- "manifest unknown" 오류의 근본 원인 제거
- 올바른 이미지명과 태그로 정상적인 pull 수행

### 2. 배포 안정성 대폭 향상
- 이미지 존재 여부 사전 검증으로 실패 확률 최소화
- 'latest' 태그 자동 fallback으로 배포 연속성 보장
- 상세한 디버깅 정보로 문제 발생 시 빠른 원인 파악

### 3. 운영 효율성 개선
- Docker Compose 경고 메시지 완전 제거
- 더 깔끔하고 읽기 쉬운 배포 로그
- GitHub Actions와 배포 스크립트 간 완벽한 환경변수 일관성

### 4. 모니터링 및 디버깅 강화
- Container Registry API를 통한 실시간 이미지 상태 확인
- 로컬 이미지 목록 및 레지스트리 상태 가시성 제공
- 배포 실패 시 구체적이고 실용적인 오류 정보

## 검증 방법

다음 배포 시 확인해야 할 사항:
1. **태그 일치성**: 빌드된 이미지 태그와 배포 시 참조 태그가 정확히 일치하는지
2. **이미지 pull 성공**: "manifest unknown" 오류 없이 이미지 pull이 성공하는지
3. **fallback 동작**: 특정 태그 실패 시 'latest' 태그로 자동 전환되는지
4. **디버깅 정보**: 배포 로그에서 충분한 디버깅 정보가 제공되는지
5. **애플리케이션 정상 동작**: 컨테이너 시작 및 health check 통과 여부

## 결론

이번 오류의 **핵심 원인**은 **Docker 이미지 태깅 불일치**였습니다. GitHub Actions의 metadata-action이 `main-453a6545...` 형태로 태그를 생성했지만, 배포 스크립트는 `453a6545...` 형태를 기대하여 "manifest unknown" 오류가 발생했습니다.

**해결의 핵심**:
1. **태그 형식 통일**: metadata-action에서 브랜치 prefix 제거
2. **이미지명 불일치 해결**: 환경변수 전달 개선 및 올바른 기본값 설정  
3. **배포 안정성 강화**: 사전 검증, fallback 기능, 상세 디버깅 추가

이러한 종합적인 개선을 통해 배포 프로세스의 안정성과 신뢰성을 대폭 향상시켰으며, 향후 유사한 문제 발생 시 빠른 진단과 해결이 가능한 구조를 구축했습니다.