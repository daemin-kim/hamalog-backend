name: ë©”ì¸ ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ í”„ë¡œë•ì…˜ ë°°í¬

# ë©”ì¸ ë¸Œëœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë  ë•Œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰
on:
  push:
    branches:
      - main
  # GitHub UIì—ì„œ ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©
  workflow_dispatch:

# ëª¨ë“  ì‘ì—…ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Hamalog ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
    runs-on: ubuntu-latest
    
    # ì›Œí¬í”Œë¡œìš°ì— í•„ìš”í•œ ê¶Œí•œ
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: Java 21 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          
      - name: Gradle íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
            
      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew
        
      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ”¨ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë¹Œë“œí•˜ê³  í…ŒìŠ¤íŠ¸í•˜ëŠ” ì¤‘..."
          ./gradlew clean build
          
      - name: ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: í”„ë¡œë•ì…˜ ì„œë²„ì— ë°°í¬
        run: |
          echo "ğŸš€ ë°°í¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹œì‘í•˜ëŠ” ì¤‘..."
          
          # í”„ë¡œë•ì…˜ ë°°í¬ìš© í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (docker-build.ymlê³¼ ë™ê¸°í™”)
          export SPRING_PROFILES_ACTIVE=prod
          export MYSQL_ROOT_PASSWORD="${{ secrets.MYSQL_ROOT_PASSWORD }}"
          export DB_NAME="${{ secrets.DB_NAME }}"
          export DB_USERNAME="${{ secrets.DB_USERNAME }}"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export JWT_SECRET="${{ secrets.JWT_SECRET }}"
          export JWT_EXPIRY="${{ secrets.JWT_EXPIRY }}"
          export KAKAO_CLIENT_ID="${{ secrets.KAKAO_CLIENT_ID }}"
          export KAKAO_CLIENT_SECRET="${{ secrets.KAKAO_CLIENT_SECRET }}"
          
          # ì‹œí¬ë¦¿ì´ ë¹„ì–´ìˆì„ ê²½ìš° ê¸°ë³¸ê°’ ì„¤ì • (docker-build.yml ì ‘ê·¼ ë°©ì‹ê³¼ ì¼ì¹˜)
          if [ -z "$MYSQL_ROOT_PASSWORD" ]; then export MYSQL_ROOT_PASSWORD="mypassword"; fi
          if [ -z "$DB_NAME" ]; then export DB_NAME="Hamalog"; fi
          if [ -z "$DB_USERNAME" ]; then export DB_USERNAME="user"; fi
          if [ -z "$DB_PASSWORD" ]; then export DB_PASSWORD="password"; fi
          if [ -z "$JWT_SECRET" ]; then export JWT_SECRET="xcrVqYlPMcLeEoEX+h8vjxZ97lS6AETwQJXJSLJ/h8g="; fi
          if [ -z "$JWT_EXPIRY" ]; then export JWT_EXPIRY="3600000"; fi
          
          # ë™ê¸°í™”ëœ docker-compose ì„¤ì • ìƒì„±
          cat > docker-compose.prod.yml << EOF
          services:
            hamalog-app:
              image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
              ports:
                - "8080:8080"
              environment:
                - SPRING_PROFILES_ACTIVE=prod
                - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-hamalog:3306/\${DB_NAME}
                - SPRING_DATASOURCE_USERNAME=\${DB_USERNAME}
                - SPRING_DATASOURCE_PASSWORD=\${DB_PASSWORD}
                - SPRING_DATA_REDIS_HOST=redis
                - SPRING_DATA_REDIS_PORT=6379
                - JWT_SECRET=\${JWT_SECRET}
                - JWT_EXPIRY=\${JWT_EXPIRY}
                - KAKAO_CLIENT_ID=\${KAKAO_CLIENT_ID}
                - KAKAO_CLIENT_SECRET=\${KAKAO_CLIENT_SECRET}
              depends_on:
                mysql-hamalog:
                  condition: service_healthy
                redis:
                  condition: service_healthy
              restart: unless-stopped

            redis:
              image: redis:7-alpine
              ports:
                - "6379:6379"
              command: redis-server --appendonly yes
              volumes:
                - redis-data:/data
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "redis-cli", "ping"]
                interval: 30s
                timeout: 10s
                retries: 3

            mysql-hamalog:
              image: mysql:8.0
              ports:
                - "3306:3306"
              environment:
                - MYSQL_ROOT_PASSWORD=\${MYSQL_ROOT_PASSWORD}
                - MYSQL_DATABASE=\${DB_NAME}
                - MYSQL_USER=\${DB_USERNAME}
                - MYSQL_PASSWORD=\${DB_PASSWORD}
              volumes:
                - mysql-data:/var/lib/mysql
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p\${MYSQL_ROOT_PASSWORD}"]
                interval: 30s
                timeout: 10s
                retries: 3

          volumes:
            mysql-data:
            redis-data:
          EOF
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
          echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆë¥¼ ì¤‘ì§€í•˜ëŠ” ì¤‘..."
          docker compose -p hamalog -f docker-compose.prod.yml down --remove-orphans || true
          
          # ìµœì‹  ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
          echo "â¬‡ï¸ ìµœì‹  ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          
          # ì„œë¹„ìŠ¤ ì‹œì‘
          echo "ğŸš€ ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘í•˜ëŠ” ì¤‘..."
          docker compose -p hamalog -f docker-compose.prod.yml up -d
          
      - name: ë°°í¬ í™•ì¸
        run: |
          echo "âœ… ë°°í¬ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘..."
          
          # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸°
          sleep 30
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          docker compose -p hamalog -f docker-compose.prod.yml ps
          
          # ê¸°ë³¸ ìƒíƒœ í™•ì¸
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "ì‹œë„ $attempt: ì• í”Œë¦¬ì¼€ì´ì…˜ í…ŒìŠ¤íŠ¸ ì¤‘..."
            
            if curl -f -s -m 10 http://localhost:8080/actuator/health >/dev/null 2>&1; then
              echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒ ìƒíƒœì…ë‹ˆë‹¤!"
              break
            fi
            
            if [ $attempt -eq $max_attempts ]; then
              echo "âŒ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨"
              docker compose -p hamalog -f docker-compose.prod.yml logs hamalog-app --tail=50
              exit 1
            fi
            
            sleep 10
            attempt=$((attempt + 1))
          done
          
      - name: ì •ë¦¬ ì‘ì—…
        run: |
          echo "ğŸ§¹ ì •ë¦¬ ì‘ì—… ì¤‘..."
          rm -f docker-compose.prod.yml
          docker image prune -f || true
          
      - name: ë°°í¬ ì•Œë¦¼
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ğŸŒ ì• í”Œë¦¬ì¼€ì´ì…˜ URL: http://localhost:8080"
          else
            echo "âŒ ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"
          fi